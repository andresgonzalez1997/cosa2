#!/usr/bin/env python3
# quick_statesville.py

import sys
import re
import datetime
import pandas as pd
import fitz       # pip install pymupdf
import tabula     # pip install tabula-py

def effective_date(path):
    """
    Extrae la fecha (p.ej. 10/07/2024) de la zona y=50..130 pt en la página 1.
    Devuelve ISO 'YYYY‑MM‑DD' o cadena vacía.
    """
    try:
        doc  = fitz.open(path)
        page = doc.load_page(0)
        clip = fitz.Rect(0, 50, page.rect.width, 130)
        txt  = page.get_text("text", clip=clip)
        m    = re.search(r"\b\d{1,2}/\d{1,2}/(?:\d{2}|\d{4})\b", txt)
        if not m:
            return ""
        for fmt in ("%m/%d/%Y", "%m/%d/%y"):
            try:
                return datetime.datetime.strptime(m.group(0), fmt).date().isoformat()
            except ValueError:
                continue
    except Exception:
        pass
    return ""

def plant_location(path):
    """
    Extrae la ubicación de planta (p.ej. "HUDSON'S") de la zona y=0..50 pt en la página 1.
    Devuelve la primera línea limpia.
    """
    try:
        doc  = fitz.open(path)
        page = doc.load_page(0)
        clip = fitz.Rect(0, 0, page.rect.width, 50)
        txt  = page.get_text("text", clip=clip).upper()
        if "HUDSON'S" in txt:
            return "HUDSON'S"
        return txt.split("\n", 1)[0].strip().replace(",", "")
    except Exception:
        return ""

def read_file(path):
    """
    1) Usa tabula-py para leer TODO el PDF en un solo DataFrame.
    2) Normaliza nombres de columnas.
    3) Agrega plant_location, date_inserted y source.
    """
    # Lee todo el PDF sin dividir en múltiples tablas
    dfs = tabula.read_pdf(
        path,
        pages="all",
        guess=True,
        multiple_tables=False
    )
    if not dfs:
        raise RuntimeError("Tabula no extrajo ninguna tabla del PDF.")

    df = dfs[0]

    # Normaliza nombres de columnas: strip, lowercase, espacios→_
    df.columns = [c.strip().lower().replace(" ", "_") for c in df.columns]

    # Agrega metadatos
    df["plant_location"] = plant_location(path)
    df["date_inserted"]  = effective_date(path)
    df["source"]         = "pdf"

    return df

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Uso: python quick_statesville.py <ruta_al_pdf>")
        sys.exit(1)

    pdf_path = sys.argv[1]
    df = read_file(pdf_path)

    print("\n--- TIPOS DEL DATAFRAME ---")
    print(df.dtypes, "\n")

    print("--- INFO DEL DATAFRAME FINAL ---")
    df.info()

    print("\n--- MUESTRA DE FILAS ---")
    print(df.head())
